<!DOCTYPE html>
<html>
<head>
  <title>Atlas - Fix JSON Content</title>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    .container {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    h1 { color: #B2BDA3; margin-bottom: 20px; }
    button {
      background: #B2BDA3;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover { background: #A3B295; }
    button:disabled {
      background: #555;
      color: #999;
      cursor: not-allowed;
    }
    .log {
      background: #000;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
    .warn { color: #fbbf24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üõ†Ô∏è Atlas Message Content Fixer</h1>
    <p>This tool will fix messages that display JSON like:</p>
    <code style="background: #000; padding: 10px; display: block; margin: 10px 0; border-radius: 5px;">
      {"type":"text","text":"I notice your wow..."}
    </code>
    
    <p style="margin-top: 20px;">It will extract the text and update your local database.</p>
    
    <div style="margin-top: 30px;">
      <button id="scanBtn" onclick="scanMessages()">üîç Scan Messages</button>
      <button id="fixBtn" onclick="fixMessages()" disabled>üîß Fix All Messages</button>
      <button id="reloadBtn" onclick="location.reload()" style="background: #555;">üîÑ Reload Page</button>
    </div>
    
    <div id="log" class="log"></div>
  </div>

  <script>
    let messagesToFix = [];
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    async function scanMessages() {
      const scanBtn = document.getElementById('scanBtn');
      const fixBtn = document.getElementById('fixBtn');
      scanBtn.disabled = true;
      
      try {
        log('üîç Opening IndexedDB...', 'info');
        
        const db = new Dexie('AtlasDatabase');
        db.version(1).stores({
          messages: 'id, conversationId, userId, timestamp, synced, updatedAt'
        });
        
        log('üìä Scanning all messages...', 'info');
        const allMessages = await db.messages.toArray();
        log(`‚úÖ Found ${allMessages.length} total messages`, 'success');
        
        messagesToFix = [];
        
        for (const msg of allMessages) {
          if (typeof msg.content === 'string' && 
              msg.content.trim().startsWith('{') &&
              msg.content.includes('"type"') && 
              msg.content.includes('"text"')) {
            try {
              const parsed = JSON.parse(msg.content);
              if (parsed.text) {
                messagesToFix.push({
                  id: msg.id,
                  oldContent: msg.content,
                  newContent: parsed.text
                });
              }
            } catch (e) {
              log(`‚ö†Ô∏è Skipped message ${msg.id} (invalid JSON)`, 'warn');
            }
          }
        }
        
        if (messagesToFix.length === 0) {
          log('‚úÖ No messages need fixing! Your database is clean.', 'success');
          scanBtn.disabled = false;
        } else {
          log(`üéØ Found ${messagesToFix.length} messages that need fixing`, 'warn');
          log('üìù Preview of fixes:', 'info');
          
          messagesToFix.slice(0, 3).forEach((msg, idx) => {
            log(`   ${idx + 1}. ${msg.newContent.substring(0, 60)}...`, 'info');
          });
          
          fixBtn.disabled = false;
          log('‚úÖ Ready to fix! Click "Fix All Messages" button', 'success');
        }
        
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        scanBtn.disabled = false;
      }
    }
    
    async function fixMessages() {
      const fixBtn = document.getElementById('fixBtn');
      const reloadBtn = document.getElementById('reloadBtn');
      fixBtn.disabled = true;
      
      try {
        log(`üîß Fixing ${messagesToFix.length} messages...`, 'info');
        
        const db = new Dexie('AtlasDatabase');
        db.version(1).stores({
          messages: 'id, conversationId, userId, timestamp, synced, updatedAt'
        });
        
        let fixed = 0;
        
        for (const msg of messagesToFix) {
          await db.messages.update(msg.id, { content: msg.newContent });
          fixed++;
          
          if (fixed % 10 === 0) {
            log(`   ‚úì Fixed ${fixed}/${messagesToFix.length}...`, 'info');
          }
        }
        
        log(`‚úÖ SUCCESS! Fixed ${fixed} messages`, 'success');
        log('üîÑ Reload the page to see clean messages', 'success');
        
        reloadBtn.style.background = '#4ade80';
        reloadBtn.style.animation = 'pulse 1s infinite';
        
      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        fixBtn.disabled = false;
      }
    }
    
    log('‚úÖ Ready! Click "Scan Messages" to begin', 'success');
  </script>
</body>
</html>

