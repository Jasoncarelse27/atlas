name: CI – Fast Gate + Build

on:
  pull_request:
    branches: ['**']            # run on all PRs
    paths-ignore:
      - '**/*.md'
      - '**/*.MD'
  push:
    branches: ['main']          # full gate on main
    paths-ignore:
      - '**/*.md'
      - '**/*.MD'

jobs:
  fast-gate:
    if: github.event_name == 'pull_request'
    name: Fast Gate (types + tests)
    runs-on: ubuntu-latest
    env:
      # CI-safe defaults so builds/tests don't error on missing env
      VITE_APP_URL: http://localhost:5173
      EMAIL_LIVE_MODE: 'false'
      EMAIL_DRY_RUN: 'true'
      EMAIL_ALLOWLIST: ''
      HUSKY: '0'                # don't install husky in CI
      CI: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node 22.12.0
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'

      - name: Versions
        run: |
          node -v
          npm -v

      - name: Install
        run: npm ci --no-audit --no-fund

      - name: Run fast gate
        run: npm run check:fast

      - name: Build (smoke)
        run: npm run build

  full-gate:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/main')
    name: Full Gate (install + types + lint + build + tests)
    runs-on: ubuntu-latest
    env:
      VITE_APP_URL: http://localhost:5173
      EMAIL_LIVE_MODE: 'false'
      EMAIL_DRY_RUN: 'true'
      EMAIL_ALLOWLIST: ''
      HUSKY: '0'
      CI: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node 22.12.0
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'

      - name: Versions
        run: |
          node -v
          npm -v

      - name: Install
        run: npm ci --no-audit --no-fund

      - name: Full gate
        run: npm run check:all

      - name: Verify build artifacts
        run: |
          if [ -d dist ] || [ -d build ]; then
            echo "✅ Build folder present"
          else
            echo "ℹ️  No build folder from check:all; running standalone build…"
            npm run build
          fi