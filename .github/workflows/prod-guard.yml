name: Production Guard

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  block-test-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper diff

      - name: Check for test seeding SQL files
        run: |
          echo "🔍 Checking for test seeding SQL migrations..."
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "supabase/migrations/.*seed_test_accounts.*.sql"; then
            echo "🚨 Test seeding migration detected in push/PR to main!"
            echo "❌ Files found:"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "supabase/migrations/.*seed_test_accounts.*.sql"
            echo ""
            echo "💡 These files should only exist in staging branches, not main."
            echo "🔄 Please remove or move these files before merging to main."
            exit 1
          fi
          echo "✅ No test seeding SQL migrations detected"

      - name: Check for test seeding workflow
        run: |
          echo "🔍 Checking for test seeding workflow files..."
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q ".github/workflows/seed-test-accounts.yml"; then
            echo "🚨 Test seeding workflow detected in push/PR to main!"
            echo "❌ Files found:"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep ".github/workflows/seed-test-accounts.yml"
            echo ""
            echo "💡 Test workflows should only exist in staging branches, not main."
            echo "🔄 Please remove or move these files before merging to main."
            exit 1
          fi
          echo "✅ No test seeding workflow files detected"

      - name: Check for test data files
        run: |
          echo "🔍 Checking for test data files..."
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -v "supabase/test_seeds/" | grep -q -E "(test.*\.sql|seed.*\.sql|dummy.*\.sql)"; then
            echo "🚨 Test data files detected in push/PR to main!"
            echo "❌ Files found:"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -v "supabase/test_seeds/" | grep -E "(test.*\.sql|seed.*\.sql|dummy.*\.sql)"
            echo ""
            echo "💡 Test data files should only exist in staging branches, not main."
            echo "🔄 Please remove or move these files before merging to main."
            exit 1
          fi
          echo "✅ No test data files detected"

      - name: No forbidden files detected
        run: |
          echo "✅ Production Guard: No forbidden test artifacts detected in main branch."
          echo "🛡️ Main branch is production-safe!"
          echo ""
          echo "📋 Protected patterns:"
          echo "  - supabase/migrations/*seed_test_accounts*.sql"
          echo "  - .github/workflows/seed-test-accounts.yml"
          echo "  - test*.sql, seed*.sql, dummy*.sql files (excluding supabase/test_seeds/)"
