name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (staging/production)"
        required: true
        default: staging
      reason:
        description: "Reason for rollback"
        required: true
      confirm:
        description: "Type ROLLBACK to confirm"
        required: true

jobs:
  rollback:
    if: github.event.inputs.confirm == 'ROLLBACK'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run Rollback Notification (STARTED)
        run: ./scripts/notify-rollback.sh "${{ github.event.inputs.environment }}" "STARTED: ${{ github.event.inputs.reason }}"

      - name: Run Rollback SQL
        run: psql $SUPABASE_DB_URL -f supabase/migrations/20250914_rollback_subscription_columns.sql

      - name: Run Rollback Notification (SUCCEEDED)
        if: success()
        run: ./scripts/notify-rollback.sh "${{ github.event.inputs.environment }}" "SUCCEEDED: ${{ github.event.inputs.reason }}"

      - name: Run Rollback Notification (FAILED)
        if: failure()
        run: ./scripts/notify-rollback.sh "${{ github.event.inputs.environment }}" "FAILED: ${{ github.event.inputs.reason }}"