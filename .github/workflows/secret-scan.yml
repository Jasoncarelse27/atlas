name: Secret Scan

on:
  pull_request:
  push:
    branches: [main, develop]
  schedule:
    - cron: "0 3 * * *" # daily at 03:00 UTC

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gitleaks Secret Scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --config=.gitleaks.toml --source . --redact

      - name: Notify Slack/Discord on Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"ðŸš¨ Secret Scan FAILED in *${{ github.repository }}* on *${{ github.ref_name }}*. Check workflow logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
          ${{ secrets.CICD_ALERT_URL }}

      - name: Success Notification
        if: success()
        run: |
          echo "âœ… Secret scan completed successfully - no secrets detected"
