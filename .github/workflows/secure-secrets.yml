name: Secure Secrets Check

on: [push, pull_request]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify Rollback Secrets Configuration
        run: |
          echo "üîç Checking rollback notification secrets..."
          
          # Check if required secrets are configured
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ùå Missing SLACK_WEBHOOK_URL secret"
            echo "   Please set this secret in GitHub repository settings"
            echo "   Format: https://hooks.slack.com/services/..."
            exit 1
          fi
          
          if [ -z "$CICD_ALERT_URL" ]; then
            echo "‚ùå Missing CICD_ALERT_URL secret"
            echo "   Please set this secret in GitHub repository settings"
            echo "   Format: https://rbwabemtucdkytvvpzvk.supabase.co/functions/v1/cicd-alert"
            exit 1
          fi
          
          if [ -z "$CICD_ALERT_TOKEN" ]; then
            echo "‚ùå Missing CICD_ALERT_TOKEN secret"
            echo "   Please set this secret in GitHub repository settings"
            echo "   This should be your Supabase Service Role Key"
            exit 1
          fi
          
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "‚ö†Ô∏è  Missing SUPABASE_DB_URL secret"
            echo "   This is optional but recommended for automatic rollback execution"
            echo "   Format: postgres://user:password@host:port/database"
          fi
          
          echo "‚úÖ All required rollback secrets are configured"
          echo "‚úÖ Rollback protection system is ready"

      - name: Test Notification Script Syntax
        run: |
          echo "üß™ Testing notification script syntax..."
          bash -n scripts/notify-rollback.sh
          echo "‚úÖ Notification script syntax is valid"

      - name: Verify Migration Files
        run: |
          echo "üìã Verifying migration files exist..."
          
          if [ ! -f "supabase/migrations/20250914_rollback_subscription_columns.sql" ]; then
            echo "‚ùå Missing rollback migration file"
            exit 1
          fi
          
          if [ ! -f "supabase/migrations/20250914_update_migration_log.sql" ]; then
            echo "‚ùå Missing migration log update file"
            exit 1
          fi
          
          echo "‚úÖ All migration files are present"
