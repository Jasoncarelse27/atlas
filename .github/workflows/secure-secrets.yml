name: Secure Secrets Check

on: [push, pull_request]

permissions:
  contents: read

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify Rollback Secrets Configuration
        run: |
          echo "ğŸ” Checking rollback notification secrets..."
          
          # Check if required secrets are configured
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "âŒ Missing SLACK_WEBHOOK_URL secret"
            echo "   Please set this secret in GitHub repository settings"
            echo "   Format: https://hooks.slack.com/services/..."
            exit 1
          fi
          
          if [ -z "${{ secrets.CICD_ALERT_URL }}" ]; then
            echo "âŒ Missing CICD_ALERT_URL secret"
            echo "   Please set this secret in GitHub repository settings"
            echo "   Format: https://your-project.supabase.co/functions/v1/cicd-alert"
            exit 1
          fi
          
          if [ -z "${{ secrets.CICD_ALERT_TOKEN }}" ]; then
            echo "âŒ Missing CICD_ALERT_TOKEN secret"
            echo "   Please set this secret in GitHub repository settings"
            echo "   This should be your Supabase Service Role Key"
            exit 1
          fi
          
          if [ -z "${{ secrets.SUPABASE_DB_URL }}" ]; then
            echo "âš ï¸  Missing SUPABASE_DB_URL secret"
            echo "   This is optional but recommended for automatic rollback execution"
            echo "   Format: postgres://user:password@host:port/database"
          fi
          
          echo "âœ… All required rollback secrets are configured"
          echo "âœ… Rollback protection system is ready"

      - name: Test Notification Script Syntax
        run: |
          echo "ğŸ§ª Testing notification script syntax..."
          bash -n scripts/notify-rollback.sh
          echo "âœ… Notification script syntax is valid"

      - name: Verify Migration Files
        run: |
          echo "ğŸ“‹ Verifying migration files exist..."
          
          if [ ! -f "supabase/migrations/20250914_rollback_subscription_columns.sql" ]; then
            echo "âŒ Missing rollback migration file"
            exit 1
          fi
          
          if [ ! -f "supabase/migrations/20250914_update_migration_log.sql" ]; then
            echo "âŒ Missing migration log update file"
            exit 1
          fi
          
          echo "âœ… All migration files are present"

      - name: Check for Hardcoded Secrets
        run: |
          echo "ğŸ” Scanning for potential hardcoded secrets..."
          
          # Check for hardcoded Slack webhook URLs
          if grep -r "hooks\.slack\.com" . --exclude-dir=.git --exclude="*.md" --exclude="*.example" 2>/dev/null; then
            echo "âŒ Found potential hardcoded Slack webhook URLs"
            echo "   Please use GitHub secrets instead"
            exit 1
          fi
          
          # Check for hardcoded Supabase URLs (excluding documentation)
          if grep -r "rbwabemtucdkytvvpzvk\.supabase\.co" . --exclude-dir=.git --exclude="*.md" --exclude="*.example" 2>/dev/null; then
            echo "âŒ Found potential hardcoded Supabase URLs"
            echo "   Please use environment variables or GitHub secrets"
            exit 1
          fi
          
          # Check for potential API keys
          if grep -r "sk-[a-zA-Z0-9]" . --exclude-dir=.git --exclude="*.md" --exclude="*.example" 2>/dev/null; then
            echo "âŒ Found potential hardcoded API keys"
            echo "   Please use GitHub secrets instead"
            exit 1
          fi
          
          echo "âœ… No hardcoded secrets detected"